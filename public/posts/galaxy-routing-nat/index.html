<!DOCTYPE html>
<html lang="en-us">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<meta name="theme-color" content="#333">
	<meta name="msapplication-TileColor" content="#333">
<meta itemprop="name" content="Ames indirect connection fixes">
<meta itemprop="description" content="Urbit&rsquo;s networking protocol, %ames, uses peer-to-peer connections to let your ship talk to others, with all traffic transported over encrypted UDP. However, in order to allow your ship to discover the IP addresses of ships you want to talk to, you have to query the network &ndash; specifically, your ship asks your star, which asks the galaxies. The answer gets relayed to you, and then you send your packets where they&rsquo;re meant to go.">
<meta itemprop="datePublished" content="2021-04-20T18:00:35-05:00" />
<meta itemprop="dateModified" content="2021-04-20T18:00:35-05:00" />
<meta itemprop="wordCount" content="787">
<meta itemprop="image" content="https://subject.network/img/ames.gif">



<meta itemprop="keywords" content="urbit,nat,networking,ames,posput-borfes," />
<meta property="og:title" content="Ames indirect connection fixes" />
<meta property="og:description" content="Urbit&rsquo;s networking protocol, %ames, uses peer-to-peer connections to let your ship talk to others, with all traffic transported over encrypted UDP. However, in order to allow your ship to discover the IP addresses of ships you want to talk to, you have to query the network &ndash; specifically, your ship asks your star, which asks the galaxies. The answer gets relayed to you, and then you send your packets where they&rsquo;re meant to go." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://subject.network/posts/galaxy-routing-nat/" />
<meta property="og:image" content="https://subject.network/img/ames.gif" />
<meta property="article:published_time" content="2021-04-20T18:00:35-05:00" />
<meta property="article:modified_time" content="2021-04-20T18:00:35-05:00" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://subject.network/img/ames.gif"/>

<meta name="twitter:title" content="Ames indirect connection fixes"/>
<meta name="twitter:description" content="Urbit&rsquo;s networking protocol, %ames, uses peer-to-peer connections to let your ship talk to others, with all traffic transported over encrypted UDP. However, in order to allow your ship to discover the IP addresses of ships you want to talk to, you have to query the network &ndash; specifically, your ship asks your star, which asks the galaxies. The answer gets relayed to you, and then you send your packets where they&rsquo;re meant to go."/>

	<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
	<link rel="manifest" href="/site.webmanifest">
	<link rel="mask-icon" href="/safari-pinned-tab.svg" color="">
	<link rel="shortcut icon" href="/favicon.ico">

	<title>Ames indirect connection fixes</title>
	<link rel="stylesheet" href="https://subject.network/css/style.min.4c6a371b83a582a300e51c2f5bc419428ca22003c0c42360a78bf9ec64ace875.css" integrity="sha256-TGo3G4OlgqMA5RwvW8QZQoyiIAPAxCNgp4v57GSs6HU=" crossorigin="anonymous">
	<link rel="stylesheet" href="https://subject.network/css/override.css">
</head>

<body id="page">
	
	<header id="site-header" class="animated slideInUp">
		<div class="hdr-wrapper section-inner">
			<div class="hdr-left">
				<div class="site-branding">
					⏣ <a href="https://subject.network">networked subject</a>_
				</div>
				<nav class="site-nav hide-in-mobile">
					
				<a href="https://subject.network/posts/">Posts</a>
				<a href="https://subject.network/about/">About</a>
				<a href="https://subject.network/buy/">₿uy</a>

				</nav>
			</div>
			<div class="hdr-right hdr-icons"><button id="menu-btn" class="hdr-btn" title="Menu"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></button>
			</div>
		</div>
	</header>
	<div id="mobile-menu" class="animated fast">
		<ul>
			<li><a href="https://subject.network/posts/">Posts</a></li>
			<li><a href="https://subject.network/about/">About</a></li>
			<li><a href="https://subject.network/buy/">₿uy</a></li>
		</ul>
	</div>


	<main class="site-main section-inner animated fadeIn faster">
		<article class="thin">
			<header class="post-header">
				<div class="post-meta"><span>Apr 20, 2021</span></div>
				<h1>Ames indirect connection fixes</h1>
			</header>
			<div class="content">
				<p><img src="/img/ames.gif" alt=""></p>
<p>Urbit&rsquo;s networking protocol, <code>%ames</code>, uses peer-to-peer connections to let your ship talk to others, with all traffic transported over encrypted UDP. However, in order to allow your ship to discover the IP addresses of ships you want to talk to, you have to query the network &ndash; specifically, your ship asks your star, which asks the galaxies. The answer gets relayed to you, and then you send your packets where they&rsquo;re meant to go.</p>
<p>Sometimes, however, your packets will not get through, or vice versa. After a 30 second timeout, your ship will try routing your connection through your galaxy instead. This helps you get around  firewalls and home routers that won&rsquo;t allow connections through, at the expense of the speed of your messages arriving.</p>
<p>(As an aside, this service will eventually be performed by stars, but is done by galaxies for the time being.)</p>
<p>If you are experiencing significant latency between yourself and another ship, it may be because one of you is having your connection proxied through a galaxy. Besides very slow messages, there&rsquo;s no obvious way to tell whether this is the case, but there are a couple of tricks:</p>
<h2 id="detection">Detection<a href="#detection" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<h3 id="one-liner">One-liner<a href="#one-liner" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<blockquote>
<p>The command to use in the Urbit dojo is:</p>
</blockquote>
<div class="window">
    <div class="titlebar">
      <div class="buttons">
        <div class="bclose">
        </div>
        <div class="minimize">
        </div>
        <div class="zoom">
        </div>
      </div>
      urbit - sampel-palnet
    </div>
    <div class="termdojo">
      <ul>
        
        
        <li></li>
        
        
        <li>~sampel-palnet:dojo>&nbsp;=/(ss&nbsp;.^(ship-state:ames&nbsp;ax+/=//=/peers/~zod)&nbsp;?>(?=(%known&nbsp;-.ss)&nbsp;route.ss))</li>
        
        
        <li>~sampel-palnet:dojo></li>
        
        
        <li>&nbsp;</li>
        
        
        <li></li>
        
        
        <li>&nbsp;</li>
        
        
        <li></li>
          
      </ul>
    </div>
  </div>

<blockquote>
<p>Replace ~zod with the actual ship name.</p>
</blockquote>
<blockquote>
<p>You&rsquo;ll see something like this as a response, if your ship is in fact directly linked to the other one (instead of being indirectly routed by a star):</p>
</blockquote>
<div class="window">
    <div class="titlebar">
      <div class="buttons">
        <div class="bclose">
        </div>
        <div class="minimize">
        </div>
        <div class="zoom">
        </div>
      </div>
      urbit - sampel-palnet
    </div>
    <div class="termdojo">
      <ul>
        
        
        <li></li>
        
        
        <li>>&nbsp;=/(ss&nbsp;.^(ship-state:ames&nbsp;ax+/=//=/peers/~zod)&nbsp;?>(?=(%known&nbsp;-.ss)&nbsp;route.ss))</li>
        
        
        <li>[~&nbsp;[direct=%.y&nbsp;lane=[%.y&nbsp;p=~zod]]]</li>
        
        
        <li>&nbsp;</li>
        
        
        <li></li>
          
      </ul>
    </div>
  </div>

<p>(<a href="https://rudd-o.com/linux-and-free-software/how-to-find-out-if-your-urbit-ship-is-directly-or-indirectly-routing-to-another-urbit-ship">Source</a> &ndash; thanks, <code>~posput-borfes</code>!)</p>
<p>If your output instead says <code>direct=%.n</code>, this means your connection is indirect &ndash; i.e., proxied through a galaxy.</p>
<h3 id="debug">Debug<a href="#debug" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>Alternatively, you can run this in the dojo:</p>
<div class="window">
    <div class="titlebar">
      <div class="buttons">
        <div class="bclose">
        </div>
        <div class="minimize">
        </div>
        <div class="zoom">
        </div>
      </div>
      urbit - sampel-palnet
    </div>
    <div class="termdojo">
      <ul>
        
        
        <li></li>
        
        
        <li>~sampel-palnet:dojo>&nbsp;|start&nbsp;%dbug</li>
        
        
        <li>&nbsp;</li>
        
        
        <li></li>
        
        
        <li></li>
          
      </ul>
    </div>
  </div>

<p>Then switch to Landscape, and go to <code>/~debug</code> (e.g. http://localhost:8080/~debug ), and click on the ames tab. This will show your route for each ship.</p>
<p><img src="/img/debug.png" alt=""></p>
<p>Look for the value next to &lsquo;Route&rsquo; &ndash; &lsquo;Indirect&rsquo; means your connection is proxied.</p>
<p>After you&rsquo;re done, you may want to turn off <code>%dbug</code> &ndash; I found it slowed down my ship noticeably:</p>
<div class="window">
    <div class="titlebar">
      <div class="buttons">
        <div class="bclose">
        </div>
        <div class="minimize">
        </div>
        <div class="zoom">
        </div>
      </div>
      urbit - sampel-palnet
    </div>
    <div class="termdojo">
      <ul>
        
        
        <li></li>
        
        
        <li>~sampel-palnet:dojo>&nbsp;|fade&nbsp;%dbug</li>
        
        
        <li>&nbsp;</li>
        
        
        <li></li>
        
        
        <li></li>
          
      </ul>
    </div>
  </div>

<hr>
<h2 id="fixes">Fixes<a href="#fixes" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<h3 id="home-router">Home router<a href="#home-router" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>If you find that your ship is routing through your galaxy for all connections to other ships, it&rsquo;s because your ames port is being blocked by your firewall or router.</p>
<p>If you are behind a home router, look up a guide to <a href="https://www.noip.com/support/knowledgebase/general-port-forwarding-guide/">configure port forwarding</a> for your router&rsquo;s model or manufacturer.</p>
<p>You will need to forward your ames port &ndash; by default, this is a random UDP port between 50000 - 59999. You can forward that entire port range to the computer running the ship, or you can restart your urbit with a flag to specify a particular port, and forward that one:</p>
<div class="window" width="80%">
    <div class="titlebar">
      <div class="buttons">
        <div class="bclose">
        </div>
        <div class="minimize">
        </div>
        <div class="zoom">
        </div>
      </div>
      terminal: ~/urbit
    </div>
    <div class="termwin">
      <ul>
        
        
        <li></li>
        
        
        <li>$>&nbsp;urbit&nbsp;-p&nbsp;54321&nbsp;sampel-palnet</li>
        
        
        <li>&nbsp;</li>
        
        
        <li>&nbsp;</li>
        
        
        <li></li>
          
      </ul>
    </div>
  </div>

<p>Keep in mind that if you are forwarding to a specific IP address, that device should have a static private IP &ndash; i.e., if your home deskop runs your urbit and its IP address is 192.168.0.10, you will want to configure it so that it always claims that IP address rather than having a random one assigned via DHCP next time it reboots. Google &lsquo;static ip&rsquo; + your operating system if you aren&rsquo;t sure how.</p>
<p>A simpler fix is to instead boot your ship with <code>urbit-king</code>, (aka King Haskell) an alternative binary. <code>urbit-king</code> includes UPnP support, which will automatically configure port forwarding for compatible routers.</p>
<p>If you want to try it, you may want to take a look at the parameters, as they&rsquo;re slightly different from the <code>urbit</code> binary written in C. To boot your existing pier:</p>
<div class="window" width="80%">
    <div class="titlebar">
      <div class="buttons">
        <div class="bclose">
        </div>
        <div class="minimize">
        </div>
        <div class="zoom">
        </div>
      </div>
      terminal: ~/urbit
    </div>
    <div class="termwin">
      <ul>
        
        
        <li></li>
        
        
        <li>$>&nbsp;urbit-king&nbsp;run&nbsp;/path/to/sampel-palnet</li>
        
        
        <li>&nbsp;</li>
        
        
        <li>&nbsp;</li>
        
        
        <li></li>
          
      </ul>
    </div>
  </div>

<p>(Make sure you&rsquo;ve shut down your ship before booting it!)</p>
<p><code>urbit-king</code> also has native support for disconnecting and reconnecting to your instance without having to use <code>tmux</code>.</p>
<h3 id="vps">VPS<a href="#vps" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>If you are running your ship on a remote server, there are two possibilities for your traffic&rsquo;s obstruction &ndash; a local firewall on your VPS, or a firewall controlled via the dashboard provided by your provider. This latter type can&rsquo;t be adjusted from inside your VPS &ndash; you&rsquo;ll have to adjust it on your host&rsquo;s web control panel.</p>
<p>Fixing this for a local firewall is simple enough &ndash; just set an iptables rule to allow UDP ingress on that port. For instance, assuming you have bound your urbit to port 54321:</p>
<div class="window" width="80%">
    <div class="titlebar">
      <div class="buttons">
        <div class="bclose">
        </div>
        <div class="minimize">
        </div>
        <div class="zoom">
        </div>
      </div>
      terminal: ~/urbit
    </div>
    <div class="termwin">
      <ul>
        
        
        <li></li>
        
        
        <li>$>&nbsp;iptables&nbsp;-A&nbsp;INPUT&nbsp;-p&nbsp;udp&nbsp;-m&nbsp;udp&nbsp;--dport&nbsp;54321&nbsp;-j&nbsp;ACCEPT</li>
        
        
        <li>&nbsp;</li>
        
        
        <li>&nbsp;</li>
        
        
        <li></li>
          
      </ul>
    </div>
  </div>

<p>The latter type of firewall is a little less uniform, and I can&rsquo;t provide a universal guide here, but you can take a look at the example of Oracle&rsquo;s firewall <a href="https://subject.network/posts/free-cloud-oracle/#configuring-software">here</a>. The main thing to keep in mind is that you want to allow UDP ingress traffic on whatever your ames port is, or the port range it uses.</p>

			</div><hr>
<span class="post-footer">
<p>This post is also available on Urbit, where you can post comments. Join <b><a href="web+urbitgraph://group/~matwet/networked-subject/">~matwet/networked-subject</a></b> and open the Networked Subject notebook. <b><a href="https://urbit.org/getting-started"> Boot a free comet</a></b> or <a href="/buy"><a href="/buy"><b>Buy a planet with Bitcoin</a></b><img src="/img/btc-tiny.png">.</p>
</span> 
			<hr class="post-end">
			<footer class="post-info">
				<p>
					<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg><span class="tag"><a href="https://subject.network/tags/urbit">urbit</a></span><span class="tag"><a href="https://subject.network/tags/nat">nat</a></span><span class="tag"><a href="https://subject.network/tags/networking">networking</a></span><span class="tag"><a href="https://subject.network/tags/ames">ames</a></span><span class="tag"><a href="https://subject.network/tags/posput-borfes">posput-borfes</a></span>
				</p>
				<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>2021-04-20 18:00 -0500</p>
			</footer>
		</article>
		<div class="post-nav thin">
			<a class="next-post" href="https://subject.network/posts/urbit-windows-binaries/">
				<span class="post-nav-label"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>&nbsp;Newer</span><br><span>Building native Windows Urbit binaries</span>
			</a>
			<a class="prev-post" href="https://subject.network/posts/state-urbit-spring-2021/">
				<span class="post-nav-label">Older&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><br><span>State of Mars: Spring 2021</span>
			</a>
		</div>
		<div id="comments" class="thin">
</div>
	</main>

<footer id="site-footer" class="section-inner thin animated fadeIn faster">
<a href="https://creativecommons.org/licenses/by-sa/4.0/">
	<img src="/img/by-sa.svg" height=24px width=auto></a>
	<p><a href="/privacy">Privacy</a> | <a href="/ts">Terms</a> | <a href="/canary">♪🐦</a></p>
	<p> 2020-2022 <img src="/sitful-hatred.svg" height=24px width=24px style="vertical-align:middle;">~sitful-hatred | <a href="https://subject.network">Networked Subject</a>
<br></p>
	</footer>



	<script src="https://subject.network/js/bundle.min.4a9a0ac3d2217822c7865b4161e6c2a71de1d70492264337755427898dd718f6.js" integrity="sha256-SpoKw9IheCLHhltBYebCpx3h1wSSJkM3dVQniY3XGPY=" crossorigin="anonymous"></script>
	

</body>

</html>
